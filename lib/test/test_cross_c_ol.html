<html>

<head>
  <script src="..\BasicShape.js"></script>
  <script src="..\Canvas.js"></script>
  <script src="..\Calc.js"></script>
  <script src="..\Const.js"></script>
  <script src="..\Primitives.js"></script>
  <script src="..\ArcShapes.js"></script>
  <script src="..\Vector.js"></script>
  <script src="..\Outline.js"></script>
  <script src="..\PoligonShapes.js"></script>
  <script src="..\MouseTouchTracker.js"></script>

  <script src="..\test\ut_Obj.js"></script>
  <script src="..\test\ut_Angles.js"></script>
  <script src="..\test\ut_Calc.js"></script>
  <script src="..\test\ut_Shapes.js"></script>
  <script src="..\test\ut_Vector.js"></script>
  <script src="..\test\ut_primitives.js"></script>
</head>

<body onload="draw()">

  <div>
    <input type="checkbox" id="chkDebugMode" name="Draft">
    <label for="Draft">Draft</label>
    <input type="checkbox" id="chkShowDetails" name="Details">
    <label for="Details">Details</label>
  </div>

  <script>
    debugMode = false;
    let objDebugMode = document.querySelector('input[id="chkDebugMode"]');
    objDebugMode.addEventListener('change', () => {
      debugMode = objDebugMode.checked;
    })

    showDetails = false;
    let objShowDetails = document.querySelector('input[id="chkShowDetails"]');
    objShowDetails.addEventListener('change', () => {
      showDetails = objShowDetails.checked;
    })
  </script>

  <canvas id="canvas" style="border: 1px solid" width="800" height="800"></canvas>

  <script>
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let beginX = 0;
    let beginY = 0;
    let curX = 0;
    let curY = 0;
    let cclCmbs;

    function init() {
      cclCmbs = [];
      let cclCmb1 = new CircleComposite(475, 126, 90, [new Angle(0, DVA_PI)], CCW);
      cclCmbs.push(cclCmb1);
    }

    init();

    function draw() {
      Canvas.clearAll(ctx);
      Canvas.grid(ctx);

      let ol = buildBgShape(ctx);
      let aa;
      [aa, ol] = Calc.crossCircleOutLine(cclCmbs[0], ol);
      cclCmbs[0].setAngles(aa);
      if (aa.length > 1) {
        cclCmbs[0].mergeArcs();
      }

      ctx.save();
      ol.build(ctx);
      for (let i = 0; i < cclCmbs.length; i++) {
        cclCmbs[i].build(ctx);
      }
      ctx.globalAlpha = 0.2;
      ctx.shadowColor = '#AAAAAA'
      ctx.shadowOffsetX = 10;
      ctx.shadowOffsetY = 10;
      ctx.shadowBlur = 8;
      ctx.fillStyle = "#FF9999";
      ctx.fill();
      // ol.render(ctx, 1, DEFAULT_COLOR, "#FF9999");
      ctx.restore();

      if (debugMode) {
        pMouse = new Point(curX, curY);
        pMouse.draft(ctx, 2);
        for (let i = 0; i < cclCmbs.length; i++) {
          let cc = cclCmbs[i];
          cc.draft(ctx);
          // if (ctx.isPointInPath(cc.getPath(), curX, curY)) {
            cc.visualize(ctx);
          // }
        }
        ctx.save();
        ctx.strokeStyle = "#9999FF";
        for (let i = 0; i < ol.lines.length; i++) {
          const l = ol.lines[i];
          l.draft(ctx);
        }
        ctx.restore();
      }

      if (showDetails) {
        for (let i = 0; i < cclCmbs.length; i++) {
          cclCmbs[i].showDetails(ctx);
        }
        ol.showDetails(ctx);
      }

      window.requestAnimationFrame(draw);
    }

    function createBgShape(ctx) {
      let ol = buildBgShape(ctx);
      ctx.save();
      ctx.globalAlpha = 0.2;
      ctx.shadowColor = '#AAAAAA'
      ctx.shadowOffsetX = 10;
      ctx.shadowOffsetY = 10;
      ctx.shadowBlur = 8;
      ol.render(ctx, 1, DEFAULT_COLOR, "#FF9999");
      ctx.restore();
      return ol;
    }

    function buildBgShape(ctx) {
      let ol = new Outline([], 'olShape');
      ol.push(new Vector(50, 50, 550, 50, id = 'vec1'));
      ol.push(new Vector(550, 50, 550, 550, id = 'vec2'));
      ol.push(new Vector(550, 550, 50, 550), id = 'vec4');
      ol.push(new Vector(50, 550, 50, 50), id = 'vec5');

      // ol.push(new Vector(200, 50, 500, 50, id = 'vec1'));
      // ol.push(new Arc(500, 100, 50, new Angle(3 * PI / 2, DVA_PI)), id = 'arc1');
      // ol.push(new Vector(550, 100, 550, 400, id = 'vec2'));
      // ol.push(new Vector(550, 400, 400, 550, id = 'vec3'));
      // ol.push(new Vector(400, 550, 100, 550), id = 'vec4');
      // ol.push(new Arc(100, 500, 50, new Angle(PI / 2, PI)), id = 'arc2');
      // ol.push(new Vector(50, 500, 50, 200), id = 'vec5');
      // ol.push(new Arc(50, 50, 150, new Angle(PI / 2, 0), CCW), id = 'arc3');
      return ol;
    }



    let mtt = new MouseTouchTracker(canvas,
      function (evtType, x, y) {                         // callback 
        curX = x;
        curY = y;
        switch (evtType) {
          case 'down':
            beginX = x;
            beginY = y;
            for (let i = 0; i < cclCmbs.length; i++)
              cclCmbs[i].startDrugIfPointIsInside(ctx, x, y);
            break;

          case 'up':
            for (let i = 0; i < cclCmbs.length; i++)
              cclCmbs[i].stopDrag();
            break;

          case 'move':
            let dx = x - beginX;
            let dy = y - beginY;
            beginX = x;
            beginY = y;

            for (let i = 0; i < cclCmbs.length; i++) {
              cclCmbs[i].moveIfDragging(dx, dy);
            }
            break;
        }
      }
    );


  </script>
</body>

</html>